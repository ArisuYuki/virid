# ðŸ›°ï¸ @virid/core

> **A Lightweight, Message-Driven Logic Engine inspired by Rust's ECS Architecture and Nestjs.** **å— Rust Bevy ECS æž¶æž„ä¸ŽNestjså¯å‘çš„è½»é‡çº§æ¶ˆæ¯é©±åŠ¨é€»è¾‘å¼•æ“Žã€‚**

## âœ¨ ç‰¹ç‚¹

### ðŸ§© ä»€ä¹ˆæ˜¯ CCS æž¶æž„ï¼Ÿ

`virid` é‡‡ç”¨ **CCS (Controller-Component-System)** æž¶æž„ã€‚å®ƒåœ¨ä¼ ç»Ÿ ECS çš„åŸºç¡€ä¸Šï¼Œä¸º Web/UI çŽ¯å¢ƒå¼•å…¥äº†â€œæŽ§åˆ¶å™¨â€å±‚ï¼Œå®žçŽ°äº†é€»è¾‘ä¸Žè§†å›¾çš„å®Œç¾Žæ¡¥æŽ¥ã€‚

#### 1. ðŸ’¾ Component (æ•°æ®) â€”â€” â€œé€»è¾‘çš„å®¹å™¨â€

- **å®šä¹‰**ï¼šçº¯ç²¹çš„æ•°æ®ç»“æž„ï¼Œä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ã€‚
- **èŒè´£**ï¼šå­˜å‚¨çŠ¶æ€ã€‚åœ¨ `virid` ä¸­ï¼Œå®ƒæ˜¯ IoC å®¹å™¨ç®¡ç†çš„å•ä¾‹ã€‚

#### 2. ðŸŽ® Controller (æŽ§åˆ¶å™¨) â€”â€” â€œè§†å›¾çš„é”šç‚¹â€

- **å®šä¹‰**ï¼šUI æ¡†æž¶ï¼ˆVueï¼‰ä¸Žæ ¸å¿ƒé€»è¾‘ï¼ˆCoreï¼‰ä¹‹é—´çš„ä»£ç†ã€‚
- **èŒè´£**ï¼š
  - **æŠ•å½± (Projection)**ï¼šå°† Component é‡Œçš„æ•°æ®å®‰å…¨åœ°æ˜ å°„ç»™ Vueã€‚
  - **æŒ‡ä»¤ (Command)**ï¼šæŽ¥æ”¶ç”¨æˆ·çš„ç‚¹å‡»äº‹ä»¶ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸º `Message` å‘é€ç»™å¼•æ“Žã€‚

#### 3. âš™ï¸ System (ç³»ç»Ÿ) â€”â€” â€œå› æžœçš„è£åˆ¤â€

- **å®šä¹‰**ï¼šæ— çŠ¶æ€çš„é™æ€æ–¹æ³•é›†åˆï¼Œæ˜¯é€»è¾‘å˜æ›´çš„å”¯ä¸€åˆæ³•åœºæ‰€ã€‚
- **èŒè´£**ï¼šç›‘å¬ `Message`ï¼Œæ ¹æ®æŒ‡ä»¤ä¿®æ”¹ `Component` ä¸­çš„æ•°æ®ã€‚å®ƒæ˜¯ç¡®å®šæ€§çš„ï¼Œç¡®ä¿åŒæ ·çš„è¾“å…¥æ°¸è¿œå¾—åˆ°åŒæ ·çš„è¾“å‡ºã€‚

### ðŸ› ï¸ é€»è¾‘ä¸»æƒ

#### 1. å½»åº•çš„ UI é™çº§ï¼šæ¡†æž¶æ— å…³æ ¸å¿ƒ

- **ä¸»æƒç§»äº¤**ï¼šUI æ¡†æž¶è¢«å‰¥å¤ºäº†çŠ¶æ€ç®¡ç†ä¸Žä¸šåŠ¡è°ƒåº¦çš„æƒé™ï¼Œé€€åŒ–ä¸ºçº¯ç²¹çš„ **â€œçŠ¶æ€æŠ•å½±å±‚â€**ã€‚æ‰€æœ‰çš„ä¸šåŠ¡å› æžœå¾‹ã€çŠ¶æ€æœºè½¬æ¢å‡åœ¨ `virid Core` ä¸­é—­çŽ¯æ‰§è¡Œã€‚
- **ç‰©ç†éš”ç¦»**ï¼šCore å±‚ä¸ä¾èµ–ä»»ä½• `DOM/BOM` APIã€‚æ ¸å¿ƒé€»è¾‘å¯ä»¥æ— ç¼è¿è¡Œåœ¨ **Node.js æœåŠ¡ç«¯ã€Web Workerã€ç”šè‡³æ˜¯å‘½ä»¤è¡Œ (CLI) å·¥å…·**ä¸­ã€‚
- **æ— ç¼è¿ç§»**ï¼šé€»è¾‘èµ„äº§ä¸å†ä¸Žç‰¹å®š UI æ¡†æž¶ç»‘å®šã€‚åªéœ€æ›´æ¢ä¸€ä¸ªé€‚é…å±‚ï¼Œå°±èƒ½é€‚é… vue æˆ–React åº”ç”¨ã€‚

#### 2. ç”Ÿäº§çº§çš„å¯æµ‹è¯•æ€§

- **å‘Šåˆ«æ¨¡æ‹Ÿ (Mock) åœ°ç‹±**ï¼šæ— éœ€ JSDOMï¼Œæ— éœ€æ¨¡æ‹Ÿå¤æ‚çš„æµè§ˆå™¨çŽ¯å¢ƒã€‚ç”±äºŽæ ¸å¿ƒé€»è¾‘æ˜¯çº¯ JS/TS é©±åŠ¨çš„ï¼Œå¯ä»¥ç›´æŽ¥åœ¨ Node.js ä¸­å¯åŠ¨ Coreï¼Œé€šè¿‡ **â€œå‘é€æ¶ˆæ¯ -> æ–­è¨€çŠ¶æ€â€** çš„æ–¹å¼ï¼Œå®Œæˆå¯¹å¤æ‚ä¸šåŠ¡æµçš„å•å…ƒæµ‹è¯•ã€‚
- **é€»è¾‘å›žæ”¾**ï¼šæ‰€æœ‰å‰¯ä½œç”¨éƒ½é€šè¿‡æ¶ˆæ¯è§¦å‘ï¼Œè®©ä¸šåŠ¡é€»è¾‘å˜æˆ**çº¯å‡€çš„æµæ°´çº¿**ï¼Œæ”¯æŒå¯¹çº¿ä¸Šé€»è¾‘è·¯å¾„è¿›è¡Œç¦»çº¿é‡æž„ä¸Žè‡ªåŠ¨åŒ–å›žå½’ã€‚

#### 3. å¼ºåŠ›æŽ§åˆ¶åè½¬

- **æ·±åº¦ IoC æž¶æž„**ï¼šåŸºäºŽ **InversifyJS** å®žçŽ°ä¾èµ–æ³¨å…¥ã€‚`System`ã€`Component` ä¸Ž `Controller` ä¹‹é—´é€šè¿‡å®¹å™¨è‡ªåŠ¨è£…é…ã€‚
- **åŠ¨æ€ç”Ÿå‘½å‘¨æœŸ**ï¼šæ”¯æŒé€»è¾‘æ¨¡å—çš„æŒ‰éœ€åŠ è½½ä¸Žè‡ªåŠ¨æ³¨å…¥ã€‚æ— è®ºæ˜¯å…¨å±€å•ä¾‹çš„ `System` è¿˜æ˜¯éšç»„ä»¶é”€æ¯çš„ `Controller`ï¼Œå‡ç”±å®¹å™¨ç»Ÿä¸€æŽ¥ç®¡ç”Ÿå‘½å‘¨æœŸã€‚

### ðŸŽï¸ æ¸¸æˆçº§è°ƒåº¦å¼•æ“Ž

- **ç¡®å®šæ€§ Tick æœºåˆ¶**: å¼•å…¥ç±» Bevy çš„æ¶ˆæ¯å¾ªçŽ¯ï¼Œæ‰€æœ‰é€»è¾‘å˜æ›´åœ¨ Tick ä¸­æŽ¨è¿›ã€‚
- **åŒç¼“å†²æ¶ˆæ¯æ± **: ç‰©ç†éš”ç¦»â€œæ­£åœ¨å¤„ç†â€ä¸Žâ€œæ–°äº§ç”Ÿâ€çš„æ¶ˆæ¯ï¼Œé¿æ­»å¾ªçŽ¯ä¸Žé€»è¾‘æŠ–åŠ¨ã€‚
- **ç‰©ç†éš”ç¦»æ¶ˆæ¯ç­–ç•¥**:
  - **SingleMessage (ä¿¡å·)**: è‡ªåŠ¨åˆå¹¶åŒç±»é¡¹ï¼ŒåŒ Tick å†…ä»…è§¦å‘ä¸€æ¬¡æ‰¹é‡å¤„ç†ã€‚
  - **EventMessage (äº‹ä»¶)**: ä¸¥æ ¼ä¿åºæ‰§è¡Œï¼Œç¡®ä¿é€»è¾‘é“¾æ¡çš„åŽŸå­æ€§ã€‚

### ðŸ›¡ï¸ çŠ¶æ€å®‰å…¨ä¸Žæƒé™æŽ§åˆ¶

- **åªè¯»æ•°æ®æŠ¤ç›¾**: Controller å±‚(@virid/vueä¸­)é»˜è®¤èŽ·å¾—åªè¯»ä»£ç†ï¼Œç¦æ­¢åœ¨ System ä¹‹å¤–éžæ³•ç¯¡æ”¹ Component çŠ¶æ€ã€‚
- **åŽŸå­ä¿®æ”¹åè®®**: å¼ºåˆ¶é€šè¿‡ç‰¹å®šçš„ `AtomicModifyMessage` å˜æ›´æ•°æ®ï¼Œè®©æ¯ä¸€æ¬¡çŠ¶æ€æ”¹å˜éƒ½æœ‰è¿¹å¯å¾ªã€å¯è¢«å®¡è®¡ã€‚

### ðŸ§¬ å£°æ˜Žå¼å…ƒç¼–ç¨‹

- **è£…é¥°å™¨é©±åŠ¨**: ä½¿ç”¨ `@System`, `@Message`, `@Inherit`, `@Project` ç­‰è£…é¥°å™¨ï¼Œä»¥å£°æ˜Žå¼çš„æ–¹å¼æè¿°å¤æ‚çš„ä¾èµ–ç½‘ç»œå’Œé€»è¾‘å“åº”æµã€‚
- **è‡ªåŠ¨æ•°æ®è·¯ç”±**: æ¶ˆæ¯å‘é€å³è§¦å‘ï¼Œå‚æ•°è‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™å¤æ‚çš„ç›‘å¬ä¸Žåˆ†å‘ä»£ç ã€‚

## ðŸ“– å¿«é€Ÿä¸Šæ‰‹

åªéœ€ä¸‰æ­¥ï¼Œå³å¯åœ¨çº¯ JS çŽ¯å¢ƒä¸­æž„å»ºä¸€ä¸ªå—ä¸¥æ ¼ä¿æŠ¤çš„çŠ¶æ€æœºã€‚

#### 1. å®šä¹‰ç»„ä»¶ä¸Žæ¶ˆæ¯ (Component & Message)

ç»„ä»¶(Component)æ˜¯çº¯ç²¹çš„æ•°æ®ç»“æž„ï¼Œæ¶ˆæ¯æ˜¯å”¯ä¸€çš„é©±åŠ¨å¥‘çº¦ã€‚

```ts
import {
  createvirid,
  Component,
  System,
  Message,
  SingleMessage,
  AtomicModifyMessage,
} from "@virid/core";

// Initialize the core engine
const app = createvirid();

// Define Data Entity (Component)
@Component()
class CounterComponent {
  public count = 0;
}
// Register component
app.bindComponent(CounterComponent);

// Define operation instructions (Message)
class IncrementMessage extends SingleMessage {
  constructor(public amount: number) {
    super();
  }
}
```

#### 2. ç¼–å†™ç³»ç»Ÿ (System)

ç³»ç»Ÿæ˜¯æ— çŠ¶æ€çš„é™æ€æ–¹æ³•ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥èŽ·å–ç»„ä»¶å¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚**ä½ æ— éœ€ä»»ä½•æ“ä½œï¼Œä»–ä»¬æ˜¯çº¯staticçš„ï¼Œviridä¼šè‡ªåŠ¨æ‰¾åˆ°ä»–ä»¬å¹¶æ­£ç¡®åœ°è°ƒç”¨ä»–ä»¬ã€‚**

```ts
//Define System
class CounterSystem {
  @System()
  static onIncrement(
    @Message(IncrementMessage) message: IncrementMessage,
    count: CounterComponent,
  ) {
    console.log("---------------------System----------------------");
    console.log("message :>> ", message);
    count.count += message.amount;
  }
}
```

#### 3. çº¯çŽ¯å¢ƒè¿è¡Œ (Headless Execution)

æ— éœ€æµè§ˆå™¨ï¼Œç›´æŽ¥åœ¨ Node.js æˆ–æµ‹è¯•æ¡†æž¶ä¸­é©±åŠ¨ä½ çš„ä¸šåŠ¡ã€‚

```ts
// Business logic automatically completes scheduling in the next microtask
queueMicrotask(() => {
  IncrementMessage.send(1);
  IncrementMessage.send(5);
  queueMicrotask(() => {
    AtomicModifyMessage.send(
      CounterComponent,
      (comp) => {
        console.log("----------------AtomicModifyMessage------------------");
        console.log("CounterComponent :>> ", comp);
      },
      "Check CounterComponent",
    );
  });
});
```

## ðŸ› ï¸ é«˜çº§å·¥ç¨‹å®žè·µ (Advanced Engineering)

### âš“ å…¨ç”Ÿå‘½å‘¨æœŸæ‹¦æˆª (Lifecycle Hooks & Middleware)

virid æä¾›äº†æ·±åº¦ä»‹å…¥æ¶ˆæ¯ç®¡é“çš„èƒ½åŠ›ï¼Œä½ å¯ä»¥è½»æ˜“åœ°å°†å…¶æ‰©å±•ä¸ºæ”¯æŒ **Undo/Redo**ã€**çŠ¶æ€åŒæ­¥** æˆ– **è‡ªåŠ¨æ—¥å¿—** çš„ç³»ç»Ÿã€‚

- **Middleware**: åœ¨æ¶ˆæ¯è¿›å…¥ EventHub ä¹‹å‰è¿›è¡Œé¢„å¤„ç†ã€‚

  TypeScript

  ```ts
  app.useMiddleware((message, next) => {
    console.log(`Identified message ${message.constructor.name}`);
    next(); // ç»§ç»­æµè½¬
  });
  ```

- **AOP Hooks**: é’ˆå¯¹ç‰¹å®šæ¶ˆæ¯çš„æ‰§è¡Œå‰åŽè¿›è¡Œåˆ‡é¢å¤„ç†ã€‚
  - `onBeforeExecute`: åœ¨ System é€»è¾‘è¿è¡Œå‰è§¦å‘ï¼ˆå¦‚æƒé™æ£€æŸ¥ï¼‰ã€‚
  - `onAfterExecute`: åœ¨é€»è¾‘è¿è¡ŒåŽè§¦å‘ï¼ˆå¦‚æ•°æ®æŒä¹…åŒ–ï¼‰ã€‚

  ```ts
  app.onBeforeExecute(IncrementMessage, (message, context) => {
    console.log("----------------onBeforeExecute------------------");
    console.log("message :>> ", message);
    console.log("targetClass :>> ", context.targetClass);
    console.log("methodName :>> ", context.methodName);
    console.log("params :>> ", context.params);
  });
  ```

### âš¡ åŽŸå­ä¿®æ”¹ï¼šâ€œå¿«ç…§â€ç‰¹æƒ (Atomic Modification)

ä¸ºäº†å…¼é¡¾â€œä¸¥è‹›çº¦æŸâ€ä¸Žâ€œå¼€å‘æ•ˆçŽ‡â€ï¼Œvirid å…è®¸é€šè¿‡ `AtomicModifyMessage` ç›´æŽ¥æè¿°çŠ¶æ€å˜æ›´ï¼Œè€Œæ— éœ€ç¼–å†™å®Œæ•´çš„ Systemã€‚

- **è¯­ä¹‰åŒ–å˜æ›´**ï¼šæ¯ä¸€æ¡åŽŸå­ä¿®æ”¹éƒ½å¼ºåˆ¶è¦æ±‚ä¸€ä¸ª `label`ï¼Œè®©åŽŸæœ¬â€œéšæ„çš„â€èµ‹å€¼æ“ä½œå˜å¾—å¯è¢«å®¡è®¡ã€‚
- **ä¸€è‡´æ€§ä¿è¯**ï¼šåŽŸå­ä¿®æ”¹ä¾ç„¶éµå¾ª Tick è°ƒåº¦ï¼Œç¡®ä¿æ•°æ®å˜æ›´ä¸Ž System é€»è¾‘åŒæ­¥ç”Ÿæ•ˆã€‚

### ðŸš¨ ä¸‡ç‰©çš†æ¶ˆæ¯ï¼šå¥å£®çš„å¼‚å¸¸ç›‘æŽ§ (Error as Message)

virid å°†å¼‚å¸¸è§†ä¸ºç³»ç»Ÿçš„ä¸€ç­‰å…¬æ°‘ï¼š

- **è‡ªåŠ¨å°è£…**ï¼šä»»ä½• System æˆ– Hook ä¸­çš„åŒæ­¥/å¼‚æ­¥å¼‚å¸¸ï¼Œéƒ½ä¼šè¢« Dispatcher è‡ªåŠ¨æ•èŽ·å¹¶å°è£…ä¸º `ErrorMessage`ã€‚
- **é˜²å¾¡å¼ç¼–ç¨‹**ï¼šä½ å¯ä»¥å®šä¹‰ä¸€ä¸ª `ErrorSystem` ç»Ÿä¸€å¤„ç†è¿™äº›æ¶ˆæ¯ï¼ˆå¦‚å‘é€ Sentry æ—¥å¿—æˆ–è§¦å‘ UI å‘Šè­¦ï¼‰ï¼Œç¡®ä¿æ ¸å¿ƒé€»è¾‘å¼•æ“Žæ°¸è¿œä¸ä¼šå› ä¸ºå•ä¸€ç»„ä»¶çš„å´©æºƒè€Œå®•æœºã€‚

---

## ðŸš€ ç»“è¯­ï¼šä¸ºä»€ä¹ˆæ˜¯ viridï¼Ÿ

virid ä¸æ˜¯åœ¨é‡å¤é€ ä¸€ä¸ªçŠ¶æ€åº“ï¼Œå®ƒæ˜¯åœ¨ä¸º Web å¼€å‘å¼•å…¥ä¸€å¥—**å…·å¤‡å¼ºç¡®å®šæ€§çš„å·¥ä¸šæ ‡å‡†**ã€‚

å½“ä½ çš„é¡¹ç›®ä»Žå‡ åä¸ªç»„ä»¶å¢žé•¿åˆ°å‡ åƒä¸ªï¼Œå½“ä½ çš„ä¸šåŠ¡é€»è¾‘ä»Žç®€å•çš„ CRUD å˜æˆå¤æ‚çš„è·¨ç»„ä»¶è”åŠ¨æ—¶ï¼Œvirid çš„æž¶æž„å°†ç¡®ä¿ä½ çš„ä»£ç ä¾ç„¶ï¼š**é€»è¾‘å¯å¯»è¿¹ã€ä¿®æ”¹å¯é¢„æœŸã€æµ‹è¯•å¯è„±ç¦» UIã€‚**

```
æ•°æ®æµè½¬ç¤ºæ„å›¾
User -->|Dispatch| Writer[MessageWriter]
Writer -->|Middleware| Hub[EventHub: Staging]
Hub -->|Tick/Flip| Active[EventHub: Active]
Active -->|Execute| System[System/Hook]
System -->|Update| Component[Raw Component Data]
Component -->|Reactive| UI[Vue/React View]
```
